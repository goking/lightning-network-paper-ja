# The Bitcoin Lightning Network

*Scalable Off-Chain Instant Payments*

```
Joseph Poon - joseph@lightning.network
Thaddeus Dryja - rx@awsomnet.org
January 14, 2016
DRAFT Version 0.5.9.2
``` 

[Original Paper](https://lightning.network/lightning-network-paper.pdf)

## Abstract

## 1 The Bitcoin Blockchain Scalability Problem

## 2 A Network of Micropayment Channels Can Solve Scalability

...

現状のマイクロペイメントとスケーラビリティの解決策は、第三者である管理業者(Custodian)に自分のコインと他者との残高の更新を信託することで、管理業者にトランザクションをオフロードすることである。第三者に全ての資産を信託することは、取引先リスクと取引コストの面で不利益が生じる。

...


### 2.1 Micropayment Channels Do Not Require Trust

...

もし、チャネル上の残高が [Alice:0.05, Bob:0.05]であり、取引後の残高が[Alice:0.07, Bob:0.03]である場合、ネットワークはどっちの残高が正しいのか知る必要がある。

...

それと同時に、ネットワークに流すとコスト高となり得るため、本当に必要なとき以外はブロックチェーンのタイムスタンプを使わないシステムが望まれる。

その代わり、双方はトランザクションへの署名とこのブロードキャストしないことに合意することができる。
もし双方が、2-of-2マルチシグアドレスに送金するトランザクションを作ったならば、これは現在の残高に対する合意となる。
双方はこの2-of-2トランザクションから自分自身へ0.05返金可能であることに合意したことになる。
この返金トランザクションはブロードキャストしない
ただ、双方とも、それをブロードキャストするのが望ましいと感じた時はいつでもそうできる
ブロードキャストを先延ばしにしている間は、双方は将来この拠出金の残高を変更することに合意しているとみなせる

この残高を更新するには、例えばAlice: 0.07, Bob:0.03など、双方が2-of-2マルチシグアドレスに対する新しい支出を作成すればよい。
にも関わらず、適切に設計しなければ、新しい支出と元々の返金どちらが正しいのか知るよしがないというタイムスタンプ問題が生じる。

とはいえ、タイムスタンプと日付の制限は、Bitcoinのブロックチェーンにある全てのトランザクションの完全な順序づけほど複雑ではない。
マイクロペイメントチャネルでは次の2つの状態〜現在の正しい残高とすでに失効した残高〜だけが必須となる。そこには単一の現在の正しい残高と、おそらく多くの失効した過去の残高がのみ存在することになるだろう。

これは、全ての古いトランザクションを無効にし、新しいトランザクションのみが有効とするスクリプトを考案することにより、可能となる。
無効化は、Bitcoinのアウトプットスクリプトと、他者が双方の拠出額の全てをチャネルの相手方に送付できるような依存トランザクションにより行われる。

...

### 2.2 A Network of chanels

このように、マイクロペイメントチャネルは2者間に関係を作るだけである。全ての人が他の全てとチャネルを作らないといけないのであればスケーラビリティの問題は解決しない。Bitcoinのスケーラビリティ問題はマイクロペイメントチャネルの巨大なネットワークを使うことによって実現できる。

...

## 3 Bidirectional Payment Channels

マイクロペイメントチャネルは、とある取引状態のブロードキャストを先延ばしできるようにする。この契約を執行させるには、一方の当事者に対して数日前（もしくは数日後）にトランザクションをブロードキャストする責任を表現する必要がある。ブロックチェーンは非中央集権型のタイムスタンプシステムであるため、データの妥当性を確定する非中央集権型コンセンサスの構成要素としての時計が使えるうえ、（ブロックチェーン自体の）現在の状態をイベントを順序付ける一つの方法として利用できる。

幾つかの状態がブロードキャストでき、かつ後で無効化できるタイムフレームがあれば、Bitcoinのトランザクションスクリプトによって複雑なコントラクトを作成することができる。すでにハブアンドスポーク型マイクロペイメントチャネル（およびトラステッドペイメントチャネルネットワーク）については先行研究されており、実際にハブアンドスポーク型のネットワークが構築された実例もある。しかしながら、ライトニングネットワークの双方向型マイクロペイメントチャネルは、中間ノードの破綻リスクを軽減して無限に近いスケーラビリティを実現するものであり、付録Aに記載したマリアビリティソフトフォークを必要とする。

複数のマイクロペイメントチャネルの相互接続によって、トランザクション経路のネットワークを作ることが可能になる。各経路がBGPのようなシステムでルーティングできれば、送信者は受信者への特定の経路を選べるようにになるかもしれない。出力スクリプトは受信者によって生成されたハッシュで撹乱される。このハッシュへの入力を明らかにすることにより、受信者の相手方はルートにそって資金を得ることが可能になる。

### 3.1 The Problem of Blame in Channel Creation

前述のペイメントネットワークに参加するためには、当事者がネットワーク上の他の参加者との間にマイクロペイメントチャネルを作る必要がある。
 
#### 3.1.1 Creating an Unsigned Funding Transaction

最初のチャネル出資トランザクションは、このトランザクションの入力へのチャネルの片方または双方の当事者の資金によって作られる。両当事者はこのトランザクションの入力と出力を作るが、これに署名はしない。

この出資トランザクションのアウトプットは、チャネルの双方の参加者（以下、AliceとBobとする）による単一の2-of-2マルチシグスクリプトである。元々の出資額をそれぞれの出資者に償還するために、2-of-2アウトプットから支出を作成する必要が生じるまでの間、双方の参加者は出資トランザクションの署名を交換しない。

出資トランザクションに署名しない目的は、一方の当事者がまだ存在しないトランザクションから支出することを可能にするためである。 もしAliceとBobが、出資トランザクションからの支出をブロードキャストしないまま、その出資トランザクションの署名を交換した場合、 AliceとBobが協力しなければと資金は永遠にロックされる（もしくは一方の当事者の相手方の協力に対する支払を人質として、他のコインを損失することになるかもしれない）。

AliceとBobの双方が(どちらのインプットがチャネルの総額を表しているのかを知るため)出資トランザクションへのインプットを交換し、さらに後々署名する際に使う一方の鍵を交換する。この鍵が出資トランザクションの2-of-2アウトプットに対して使われる。それは出資トランザクションを遣うには双方の署名が必要となるためである。言い換えると、出資トランザクションを遣うには、AliceとBobの双方の合意が必要ということである。

#### 3.1.2 Spending from an Unsigned Transaction

まだ署名が取り交わされていないトランザクションから支出する時に必要となるSIGHASH_NOINPUTトランザクションを、ライトニングネットワークでは2-of-2の出資トランザクションのアウトプットを支出するために使う。ソフトフォークとして実装されているSIGHASH_NOTINPUTは、当事者全員の署名が完了する前にトランザクションを支出できるようにするものであり、トランザクションは新しいsighashフラグ付きでないIDを取得するために署名されている必要がある。

SIGHASH_NOINPUTが存在しなければ、Bitcoinのトランザクションはブロードキャストする前に支出できない。これはつまり、他の当事者に対して先に支払を済ませなければ契約書を起草できないようなものである。SIGHASH_NOINPUTはこの問題を解決するためにある。詳しくは付録Aに実装内容とともに記載した。

出資トランザクションを消費するには、子となるインプットの署名に含まれる（出資トランザクションの）トランザクションIDが必要となるため、SIGHASH_NOINPUTが存在しなければ、（出資トランザクションのような）署名を交換していないトランザクションを消費するトランザクションは生成できない。トランザクションIDの構成要素には、親（つまり出資）トランザクションの署名が含まれるため、両当事者は、子トランザクションによる消費に先立って、あらかじめ親に対するそれぞれの署名を交換することが（通常は）求められる。つまり、親を消費するには、少なくともどちらかの当事者が親の署名を知らなければならず、それはどちらかの当事者が、子がまだ存在する前に親（つまり出資トランザクション）をブロードキャストできるということを意味する。SIGHASH_NOINPUTは、（親の）インプットへの署名抜きで子による支出を認めることによって、この問題を回避するものである。SIGHASH_NOINPUTによる（トランザクション作成の）手順は以下のとおりである。

1. 親（つまり出資トランザクション）を作成する
1. 子（つまり確定トランザクションとこの確定トランザクションからの全ての支出）を作成する
1. 子に署名する
1. 子の署名を交換する
1. 親に署名する
1. 親の署名を交換する
1. 親をブロックチェーン上ににブロードキャストする

ステップ6が完了するまで、誰も親をブロードキャストすること(ステップ7)はできない。両当事者は、
ステップ6まで出資トランザクションの支出するために必要な署名を、どちらからも与えられていないのである。さらに、一方の当事者がステップ6に至るまでに離脱した場合、親は（そのまま）親トランザクションとして支出されるか、さもなくば親トランザクションへの入力（として指定されたUTXO）の二重使用となる（その場合、関連する全てのトランザクションの流れが無効となる）。

#### 3.1.3 Commitment Transactions: Unenforcible Construction

未署名(かつ未ブロードキャスト)の出資トランザクションが生成された後、両当事者は初期の確約トランザクション(Commitment Transaction)に署名してそれを交換する。これらの確約トランザクションは、出資トランザクション（親）の2-of-2アウトプットの支出にあたる。しかしながら、ブロックチェーン上にブロードキャストされるのは、出資トランザクションのみである。

その（出資トランザクションの）アウトプットは支出の際に両当事者の合意を必要とする2-of-2マルチシグトランザクションであるため、出資トランザクションがブロックチェーンに取り込まれた後に、現在の残高を表すものが確約トランザクションとなる。

ほんの一つの2-of-2署名済み確約トランザクションが両当事者の間で交換されただけで、両当事者は、出資トランザクションがブロックチェーンに取り込まれた後に自分のお金を取り戻せるという確信が得られる。両当事者はチャネルの現保有残高の確定を望むまで、確約トランザクションをブロックチェーン上にブロードキャストしない。
当事者は現時点の確約トランザクションのブロードキャストによりそれ（保有残高の確定）を実行する。

確約トランザクションにより、各自の現保有残高がそれぞれの当事者に支払われる。単純な（壊れた）実装では、チャネルの相手方どちらにも全ての現保有残高を返すような2つのアウトプットをもつ単一のトランザクションを前提に、そこから2-of-2(マルチシグ)にて支出する未ブロードキャストのトランザクションを生成してしまう。このトランザクションは、初期の確約トランザクションを生成した際の元々の出資者に全ての出資金を返す役割を果たす。

例えばAliceとBobが、1.0BTC(互いの0.5BTCずつの拠出に基づく)を支出するような単一の2-of-2(マルチシグ)アウトプットを持つ出資トランザクションの作成に合意したとすれば、彼らはAliceとBobに対する0.5BTCのアウトプット2つで構成される確約トランザクションを作るだろう。

...

互いにいつでも（新しい確定トランザクションが生成されたあとであっても）確定トランザクションをブロードキャストしてよいため、少ない拠出金を受け取る方が、そのアウトプットに両者にとってより多くの価値をもつ確定トランザクションをブロードキャストする強いインセンティブを持つことになる。この結果として、チャネルはすぐさまクローズされ、拠出金が盗難されてしまう。それ故、このモデルの下では、誰もペイメントチャネルを生成できない。

#### 3.1.4 Commitment Transactions: Ascribing Blame

すべての署名された確定トランザクションはブロックチェーン上にブロードキャストしてよいため、どちらかがうまくブロードキャストできた場合には、古い確定トランザクションがブロードキャストされることを防ぐ必要がある。Bitcoinの大量のトランザクションを無効にすることは不可能であり、他の方法が必要となる。

...

しかしながら、この構築方法であっても、単に責任の所在を示すものでしかない。Bitcoinブロックチェーン上の契約を執行することはまだできない。BobはAliceが古いトランザクションをブロードキャストしないことを信じるしかない。
この時点でBobが立証できるのは、半分署名されたトランザクションを根拠に、アリスがそれをやったということのみである。

### 3.2 Creating a Channel with Contract Revocation

### 3.3 Sequence Number Maturity

#### 3.3.1 Timestop

#### 3.3.2 Revocable Commitment Transactions

#### 3.3.3 Redeeming Funds from the Channel: Cooperative Counterparties

#### 3.3.4 Creating a new Commitment Transaction and Revoking Prior Commitments

#### 3.3.5 Process for Creating Revocable Commitment Transactions

### 3.4 Cooperatively Closing Out a Channel

### 3.5 Bidirectional Channel Implications and Summary

## 4 Hashed Timelock Contract (HTLC)

### 4.1 Non-revocable HTLC Construction

### 4.2 Off-chain Revocable HTLC

### 4.3 HTLC Off-chain Termination

### 4.4 HTLC Formation and Closing Order

## 5 Key Storage

## 6 Blockchain Transaction Fees for Bidirectional Channels

## 7 Pay to Contract

## 8 The Bitcoin Lightning Network

### 8.1 Decrementing Timelocks

### 8.2 Payment Amount

### 8.3 Clearing Failure and Rerouting

### 8.4 Payment Routing

### 8.5 Fees

## 9 Risks

## 9.1 Improper Timelocks

## 9.2 Forced Expiration Spam

## 9.3 Coin Theft via Cracking

## 9.4 Data Loss

## 9.5 Forgetting to Broadcast the Transaction in Time

## 9.6 Inability to Make Necessary Soft-Forks

## 9.7 Colluding Miner Attacks

## 10 Block Size Increases and Consensus

## 11 Use Cases

## 12 Conclusion

## 13 Acknowledgements

## Appendix A Resolving Malleability

## References
